<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- import Vue before Element -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/js/common/setting.js"></script>

    <style>
        .el-header, .el-footer {
            background-color: #B3C0D1;
            color: #333;
            text-align: center;
            line-height: 60px;
        }

        .el-aside {
            background-color: #D3DCE6;
            color: #333;
            text-align: center;
            line-height: 200px;
        }

        .el-main {
            background-color: #E9EEF3;
            color: #333;
            text-align: center;
            line-height: 160px;
        }

        body {
            margin: 0;
            height: 100%;
            position: absolute;
            width: 100%;
            left: 0;
            top: 0;
        }

        .el-container:nth-child(5) .el-aside,
        .el-container:nth-child(6) .el-aside {
            line-height: 260px;
        }

        .el-container:nth-child(7) .el-aside {
            line-height: 320px;
        }

        .time {
            font-size: 13px;
            color: #999;
        }

        .bottom {
            margin-top: -14px;
            line-height: 12px;
        }

        .button {
            padding: 0;
            float: right;
        }

        .image {
            width: 100%;
            display: block;
            height: 100px;
        }

        .clearfix:before,
        .clearfix:after {
            display: table;
            content: "";
        }

        .clearfix:after {
            clear: both
        }

        .note-row-class {
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        .card-list {
            white-space: nowrap;
            display: block;
            height: 170px;
            overflow-y: hidden;
        }

        .card {
            width: 200px;
            display: inline-block;
            padding: 5px;
            padding-bottom: 15px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background-color: #ccc;
        }

        /*定义滚动条轨道 内阴影+圆角*/
        ::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            background-color: #eee;
        }

        /*定义滑块 内阴影+圆角*/
        ::-webkit-scrollbar-thumb {
            border-radius: 4px;
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, .3);
            background-color: #ccc;
        }

        .note {
            padding: 10px;
            margin: 0px;
            border-bottom: 1px solid #ccc;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note:hover {
            background-color: #D3DCE6
        }

        .frame-pan {
            border: none;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>

<div id="hello">
    <el-collapse-transition>
        <div class="card-list" v-show="showCardList" :gutter="12" @mousewheel="cardScroll" ref="cardScroll">
            <!-- <el-scrollbar id="cardScroll" moveX="100" move-y="100" size-width="100" size-height="100" > -->
            <!-- <scroller :on-infinite="infinite" ref="myscroller"> -->
            <div class="card" v-for="(item,index) in noteCards" @click="openCard(item)">
                <el-card :body-style="{ padding: '0','margin-bottom':'0px' }"  shadow="hover">
                    <img src="http://bpic.588ku.com/art_origin_min_pic/18/05/28/fb8e41c01ef15bf98175c08dd549820d.jpg"
                         class="image">
                    <div style="padding: 14px;">
                        <span>{{item.name}}</span>
                        <div class="bottom clearfix">
                            <!--<time class="time">xxxxxxxxxxxxx</time>-->
                            <!--<el-button type="text" class="button" @click="deletGroup"><i class="el-icon-delete"></i></el-button>-->
                            <el-button type="text" class="button" @click="showCardMange(index)"><i
                                    class="el-icon-more"></i></el-button>
                        </div>
                    </div>
                </el-card>

            </div>

            <!--<div class="card" @click="newNoteCard">-->
                <!--<el-card :body-style="{ padding: '0','margin-bottom':'0px' }" shadow="hover">-->
                    <!--<img src="https://bpic.588ku.com/element_water_img/18/06/14/dc2bbe7afe630eeed5883139999aa856.jpg"-->
                         <!--class="image">-->
                    <!--<div style="padding: 14px;">-->
                        <!--<span>新增笔记本</span>-->
                    <!--</div>-->
                <!--</el-card>-->
            <!--</div>-->

            <el-dialog title="卡片属性" :visible="showCardDetail" @close="closeNoteCard">
                {{currentManagedCard.name}}
                <el-button style="float: right; padding: 3px 0" type="text" @click="deleteCard(currentManagedCard.id)">
                    删除
                </el-button>
            </el-dialog>
            <!-- </el-scrollbar> -->
            <!-- </scroller> -->
        </div>
    </el-collapse-transition>
    <el-row :gutter="12">

        <el-col :span="24">
            <el-menu class="el-menu-demo" mode="horizontal" @select="handleSelect" background-color="#545c64"
                     text-color="#fff" active-text-color="#ffd04b">
                <el-menu-item index="1" @click="showCardList=!showCardList">{{currentCard.name}}</el-menu-item>
                <el-submenu index="2">
                    <template slot="title">账户</template>
                    <el-menu-item index="2-1">个人中心</el-menu-item>
                    <el-menu-item index="2-2">退出</el-menu-item>
                </el-submenu>
                <el-submenu index="3">
                    <template slot="title">笔记</template>
                    <el-menu-item index="3-1" @click="newNoteCard">创建卡片</el-menu-item>
                    <el-menu-item index="3-2" @click="createNote">创建笔记</el-menu-item>
                </el-submenu>
                <el-menu-item index="3" disabled>消息中心</el-menu-item>
                <!-- <el-menu-item index="4"><a href="https://www.ele.me" target="_blank">订单管理</a></el-menu-item> -->
            </el-menu>
        </el-col>
    </el-row>

    <!--<div style="position: absolute; top:61px; bottom: 0; left: 0; right: 0;"></div>-->
    <el-row :gutter="12" >

        <el-col :span="6"  >

            <!--<el-table :data="notes" style="width: 100%" header-row-class-name="hidden"-->
            <!--row-class-name="note-row-class" @cell-click="openNode-->
            <!--" row-click="openNode">-->
            <!--<el-table-column type="expand" label="">-->
            <!--<template slot-scope="props">-->
            <!--<el-form label-position="left" inline class="demo-table-expand">-->
            <!--<el-form-item label=""><span>{{ props.row.name }}</span>-->
            <!--</el-form-item>-->
            <!--<el-form-item label=""><span><el-button-->
            <!--@click.native.prevent="deleteRow(scope.$index, tableData4)" type="text"-->
            <!--size="small">移除</el-button></span>-->

            <!--</el-form-item>-->
            <!--</el-form>-->
            <!--</template>-->
            <!--</el-table-column>-->
            <!--<el-table-column label="bbbbbb" prop="name"></el-table-column>-->
            <!--</el-table>-->

            <div v-bind:style="{height: leftHeight+'px',overflow:'auto'}" >
                <div v-for="(item,index) in currentNoteList"  slot="reference">

                        <div class="note" @click="openNode(item)" v-on:contextmenu.prevent="rightClick($event,item)" style="white-space: nowrap;">
                            <i class="el-icon-tickets"></i>&nbsp;{{item.title}}
                        </div>


                    <!--manual-->
                </div>
            </div>


        </el-col>

        <el-col :span="18">

            <div class="line-block">&nbsp;</div>
            <el-tabs v-model="nodeTab"  @tab-click="" closable @tab-remove="removeTab">
                <el-tab-pane v-for="(item,index) in tabs" :key="item.id+''" :name="item.id+''" :label="item.title">
                    <div :style="' height: '+textHeight+'px;'">
                        <el-popover
                                placement="top"
                                trigger="hover" >
                            <div style="text-align: right; margin: 0;">
                                <el-button size="mini" type="text" v-on:click.native="openUrl('/note/view.html?id='+item.id)"><i class="el-icon-share"> 分享预览</i></el-button>
                                <el-button size="mini" type="text" @click="deleteNote(item)"><i class="el-icon-delete"> 删除</i></el-button>
                                <el-button size="mini" type="text" @click="renameNote(item)"><i class="el-icon-edit"> 重命名</i></el-button>
                            </div>
                            <el-button slot="reference" type="primary" icon="el-icon-upload" circle style="z-index:1000; position: absolute;bottom:30px; right: 20px;" @click="saveNote(item)"></el-button>
                        </el-popover>
                        <iframe :src="'/note/mkdown_edit.html?id='+item.id" :ref="'iframe_'+item.id" frameborder="0" class="frame-pan"></iframe>

                    </div>
                </el-tab-pane>


            </el-tabs>
        </el-col>

    </el-row>

</div>


</body>

<script type="text/javascript">
    var app = new Vue({
        el: '#hello',
        native: true,
        data: {
            showCardList: false,
            showCardDetail: false,
            currentCard: {
                name: '笔记本'
            },
            currentManagedCard: {
                id: 0,
                name: '笔记本'
            },
            closeIframe: true,
            dialogTableVisible: false,
            notes: {},
            currentNoteList:[],
            nodeTab: null,
            tabs: [],
            noteCards: [],

            textHeight: 400,
            leftHeight: 400
        },
        mounted() {
            window.addEventListener('cardScroll', this.cardScroll);
            this.textHeight = document.body.offsetHeight - 140;
            this.leftHeight = document.body.offsetHeight - 61;
            var that=this;


            axios.get('/note/group/list').then(function (data) {
                var noCard=localStorage.cardId==null;
                for (var i=0;i<data.length; i++) {
                    app.noteCards.push(data[i]);
                    if(!noCard && data[i].id==localStorage.cardId){
                        that.openCard(data[i]);
                    }
                }


            });

        },
        methods: {
            showCardMange(index) {
                this.currentManagedCard = this.noteCards[index];
                this.currentManagedCard.index = index;
                this.showCardDetail = true;
            },
            openCard(card) {
                var that = this;
                if (this.notes[card.id] == null) {
                    axios.post('/note/note/groupNotes',"id="+card.id).then(function (data) {
                        that.currentNoteList=data;
                        that.notes[card.id] = data;
                    }).catch(function (e) {
                        console.error(e);
                    })
                }
                that.currentCard = card;
                that.currentNoteList=this.notes[card.id];
                localStorage.cardId=card.id;
            },
            closeNoteCard() {
                this.showCardDetail = false;
            },
            removeTab(targetName) {
                let tabs = this.tabs;
                let activeName = this.nodeTab;
                if (activeName === targetName) {
                    tabs.forEach((tab, index) => {
                        if (tab.id+'' === targetName) {
                            let nextTab = tabs[index + 1] || tabs[index - 1];
                            if (nextTab) {
                                activeName = nextTab.id+'';
                            }
                        }
                    });
                }

                this.nodeTab = activeName;
                this.tabs = tabs.filter(tab => tab.id != targetName);

            },
            deleteCard() {

                var that = this;
                this.$confirm('确认删除卡片“' + this.currentManagedCard.name + '”?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios.post('/note/group/delete', 'groupId=' + this.currentManagedCard.id).then(function (data) {
                        if (data) {
                            that.$message({
                                type: 'info',
                                message: '删除成功'
                            });
                            that.showCardDetail = false;

                            var index = that.currentManagedCard.index;
                            that.currentManagedCard = {};
                            that.noteCards.splice(index, 1);
                        }
                    }).catch((e) => {
                        console.log(e);
                    })

                }).catch(() => {

                });

            },
            openNode(note) {
                var hasTab = false;
                for (var i in this.tabs) {
                    if (this.tabs[i].id == note.id) {
                        hasTab = true;
                        break;
                    }
                }
                note.changed=false;
                if (!hasTab) {
                    this.tabs.push(note)
                }
                this.nodeTab = note.id+'';
                // var win = this.$refs['iframe_'+note.id][0].contentWindow;
                // win.noteChanged=this.noteChanged;
            },
            deleteNote(item,index){

                var that=this;

                this.$confirm('删除“' + item.title + '”?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                }).then(({value}) => {
                    axios.post('/note/note/delete','id='+item.id).then(function (data) {
                        if(data){
                            for(var i in that.currentNoteList){
                                if(that.currentNoteList[i].id==item.id){
                                    that.currentNoteList.splice(i,1);
                                    for(var j in that.tabs) {
                                        if (that.tabs[j].id == item.id) {
                                            that.tabs.splice(j,1);
                                            if(that.tabs[j]!=null){
                                                that.nodeTab=that.tabs[j].id+'';
                                            }
                                            break;
                                        }
                                    }

                                    break;
                                }
                            }
                        }
                    }).catch(function () {

                    })
                })


            },
            renameNote(item){
                this.$prompt('重命名“' + item.title + '”?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                }).then(({value}) => {
                    axios.post('/note/note/rename',{title:value,id:item.id}).then(function (data) {
                        if(data){
                            item.title=value;
                        }
                    })
                }).catch(function (e) {
                    console.log(e)
                })
            },
            saveNote(item){
                var win = this.$refs['iframe_'+item.id][0].contentWindow;
                var note=win.getNote();

                axios.post('/note/note/save',note).then(function (data) {
                    if (data == note.id) {
                        win.saved();
                    }
                }).catch(function (e) {

                });
            },
            noteChanged(id){
                for(var i in this.nodeTab){
                    if(nodeTab[i].id==id){
                        nodeTab[i].changed=true;
                    }
                }
            },
            rightClick(e,item) {
                // console.log(item)
                // e.stopPropagation();
                item.popoverShow=true;
            },
            handleSelect() {

            },
            cardScroll(event) {
                this.$refs.cardScroll.scrollLeft += event.deltaY / 1.6;
            },
            newNoteCard() {
                var that = this;
                this.$prompt('输入卡片名称', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
//                    inputPattern: /[\w!#$%&'*+/=?^_`{|}~-]+(?:\.[\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/,
//                    inputErrorMessage: '邮箱格式不正确'
                }).then(({value}) => {

                    axios.post('/note/group/create', {name: value}).then(function (data) {
                        that.noteCards.push({
                            id: data,
                            name: value
                        });
                    }).catch(function (e) {
                        that.$message({
                            type: 'error',
                            message: '创建失败'
                        })
                    })
                }).catch((e) => {
//                    this.$message({
//                        type: 'info',
//                        message: '取消输入'
//                    });
                });
            },
            createNote() {
                var that = this;
                this.$prompt('输入笔记本名称', '标题', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
//                    inputPattern: /[\w!#$%&'*+/=?^_`{|}~-]+(?:\.[\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/,
//                    inputErrorMessage: '邮箱格式不正确'
                }).then(({value}) => {
                    axios.post('/note/note/save', {title: value,groupId:that.currentCard.id}).then(function (data) {
                        var note={
                            id: data,
                            groupId: that.currentCard.id,
                            title: value
                        };
                        that.currentNoteList.push(note);
                        that.openNode(note);
                    }).catch(function (e) {
                        that.$message({
                            type: 'error',
                            message: '创建失败'
                        })
                    })
                }).catch(function () {

                })
            },
            openUrl(url){
                window.open(url);
            }
        }
    });




</script>
</html>